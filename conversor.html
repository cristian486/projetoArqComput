<!DOCTYPE html>
<html>
    <header>

    </header>

    <body>
        <header>
            <h1>Conversor C para MarieJS</h1>
        </header>

        <main>
            <textarea id="codigoFonte" cols="70" rows="30">
            </textarea>

            <textarea id="codigoDestino" cols="70" rows="30">
            </textarea>

            <button id="converter">Converter</button>
        </main>

        <footer>
            <p>Arquitetura de Computadores &copy; Ciência da Computação</p>
        </footer>
    </body>

    <script>
        let botaoConverter = document.querySelector('#converter');
        let obj = {};
        let codigoMarie = [];
        let variables = []
        let operacoes = ['+', '-', '*', '/']
        let counter = 1


        // Função para fazer com que ao selecionar o código em C o código no Marie seja ressaltado
        document.querySelector('#codigoFonte').addEventListener('click', e => {
            e.preventDefault()
            
            let start = document.querySelector('#codigoFonte').selectionStart
            let end = document.querySelector('#codigoFonte').selectionEnd
            let temp = document.querySelector('#codigoFonte').value.slice(start, end)

            let chaves = Object.keys(obj)
            for(let i = 0; i < chaves.length; i++) {
                if(chaves[i].includes(temp)) {

                }
            }
        })

/*
Tipos de dados em C:
char
int
float
void

#include <stdio.h>
#include <stdlib.h>

int main() {
int n, b, c = 0;
float a;

printf("Teste");


n = 1 + 5;
b = 8 - 9;
c = 1 * 10;
a = 10 / 2;

return 0;
}



Exemplo de código para multiplicação


input
store x

input
store y

loop, load sum
add x
store sum
load y
subt v1
store y
skipcond 400
jump loop

load sum
output

halt

x, dec 0
y, dec 0
v1, dec 1
sum, dec 0








Input
Store x

input
store y

divisao, load dividendo
add v1
store dividendo
load x
subt y
store x
Skipcond 000
jump divisao



load dividendo
Output


halt

x, dec 0
y, dec 0
v1, dec 1
dividendo, dec -1
        
*/
        
        

        // Ação do botão para converter o código em C para o Marie
        botaoConverter.addEventListener('click', () => {
            codigoMarie = [];
            variables = [];
            variables.push(`v1, DEC 1\n`)
            variables.push(`SUM, DEC 0\n`)
            variables.push(`DIVIDENDO, DEC -1\n`)
            document.querySelector('#codigoDestino').textContent = '';

            document.querySelector('#codigoFonte').value.trim().split('\n').forEach(linha => {

                if((linha.includes('int') && !linha.includes('print')) || linha.includes('char') || linha.includes('float') || linha.includes('void')) {
                    convertTypeToMarie(linha.trim());                
                } else if(linha.includes('printf')) {
                    convertPrintToMarie(linha.trim());
                } else if(linha.includes('/') || linha.includes('*') || linha.includes('-') || linha.includes('+')) {
                    convertOperationToMarie(linha);
                }

            })

            let string = '';
            codigoMarie.push(`\nHALT\n`)
            codigoMarie.forEach(linha => string += linha.trim() + '\n');
            variables.forEach(variavel => string += variavel.trim() + '\n')
            document.querySelector('#codigoDestino').textContent = string;
        })

        // Função para converter tipos de dados do C para o Marie. A ideia é converter tudo para hexadecimal para dar menos trabalho
        function convertTypeToMarie(linha) {
            if(linha.includes('(') && linha.includes(')') && linha.includes('{')) {
                if(!linha.includes('main')) {

                }
            } else if(linha.includes('(') && linha.includes(')') && !linha.includes('{')) {

            } else {

                if(linha.includes(',')) {
                    let texto = linha.split(',')
                    for(let i in texto) {
                        let textoOriginal = texto[i];
                        texto[i] = texto[i].replace('int', ' ')  || texto[i].replace('float', '') || texto[i].replace('char', '')  || texto[i].replace('void', '')
                        
                        if(texto[i].includes('=')) {
                            obj[textoOriginal] = `${texto[i].split('=')[0].trim().toUpperCase()}, DEC ${texto[i].split('=')[1].trim().replace(';', '')}`;
                            variables.push(`${texto[i].split('=')[0].trim().toUpperCase()}, DEC ${texto[i].split('=')[1].trim().replace(';', '')}`);
                        } else {
                            obj[textoOriginal] = `${texto[i].trim().toUpperCase()}, DEC 0`
                            variables.push(`${texto[i].trim().toUpperCase()}, DEC 0`);
                        }
                    }                                     
                } else {
                    obj[linha] = `${linha.slice(linha.trim().indexOf(' '), linha.indexOf('=') + 1 || linha.length).toUpperCase().replace(';', '')}, DEC 0`;
                    variables.push(`${linha.slice(linha.trim().indexOf(' '), linha.indexOf('=') + 1 || linha.length).toUpperCase().replace(';', '')}, DEC 0`);
                }
            }
        }


        // Função responsável por converter o printf (Função que escreve normalmente na saída padrão) para o print do Marie
        function convertPrintToMarie(linha) {
            if(linha.includes('%')) {
                let texto = linha.slice(linha.indexOf(','), linha.length)
                texto = texto.replace(')', '')
                texto = texto.replace(';', '')
                texto = texto.split(',')
                for(let i in texto)
                    if(texto[i] != '')
                    codigoMarie.push(`Load ${texto[i]}\nOutput\n`)
            } else {
                let texto = linha.substring(linha.indexOf("(") + 1, linha.indexOf(")"));
                let hexadecimalText = texto.trim().hexEncode()
                obj[linha] = `${texto.toUpperCase().replace(';', '')}, DEC 0`;
                codigoMarie.push(`${hexadecimalText.toUpperCase().replace(';', '')}`);
            }
        }


        // Converte uma operação básica (+, -, *, /) para o Marie
        function convertOperationToMarie(linha) {
            let conta = ``;
            let operationCount = -1
            let index = 0
            let firstOperation = true
            let lastOperation
            let varDefinida = linha.slice(0, linha.indexOf('=')).toUpperCase()
            linha = linha.slice(linha.indexOf('=') + 1, linha.length)
            
            for(let i = 0; i < linha.length; i++) {
                if(verficaOperacao(linha[i]) || linha[i] === ';') {
                    operationCount++

                    if(operationCount === 1 && firstOperation) {
                        let contaAtual = linha.slice(index, i)
                        index = i
                        firstOperation = false

                        switch(lastOperation) {
                            case '+':
                                contaAtual = contaAtual.split(lastOperation)
                                conta += `LOAD ${varDefinida}\n`
                                
                                for(let i in contaAtual) {
                                    if(typeof contaAtual[i] === 'number' && isFinite(contaAtual[i])) {
                                        conta += `Add ${contaAtual[i]}\n`;
                                    } else if(contaAtual[i] != '') {
                                        variables.push(`i${counter}, DEC ${contaAtual[i]}\n`)
                                        conta+= `Add i${counter}\n`
                                        counter++
                                    }
                                }
                                conta += `Store ${varDefinida}\n`
                                break;
                            case '-':
                                contaAtual = contaAtual.split(lastOperation)
                                conta += `LOAD ${varDefinida}\n`
                                
                                for(let i in contaAtual) {
                                    if(typeof contaAtual[i] === 'number' && isFinite(contaAtual[i])) {
                                        conta += `Subt ${contaAtual[i]}\n`;
                                    } else if(contaAtual[i] != '') {
                                        variables.push(`i${counter}, DEC ${contaAtual[i]}\n`)
                                        conta+= `Subt i${counter}\n`
                                        counter++
                                    }
                                }
                                conta += `Store ${varDefinida}\n`
                                break;
                            case '*':
                                contaAtual = contaAtual.split(lastOperation)
                                
                                for(let i in contaAtual) 
                                    if(contaAtual[i] != '') 
                                        variables.push(`i${counter}, DEC ${contaAtual[i]}`)
                                
                                conta += `MULTIPLICACAOi${counter}, load SUM\n`
                                conta += `Add ${varDefinida}\n`
                                conta += `Store SUM\n`
                                conta += `Load i${counter}\n`
                                conta += `Subt v1\n`
                                conta += `Store i${counter}\n`
                                conta += `Skipcond 400\n`
                                conta += `Jump MULTIPLICACAOi${counter}\n`
                                conta += `Load ${varDefinida}\n`
                                conta += `Subt ${varDefinida}\n`
                                conta += `Add MULTIPLICACAOi${counter}\n`
                                conta += `Store ${varDefinida}\n`
                                counter++
                                break;
                            case '/':
                                contaAtual = contaAtual.split(lastOperation)
                                
                                for(let i in contaAtual) 
                                    if(contaAtual[i] != '') 
                                        variables.push(`i${counter}, DEC ${contaAtual[i]}`)
                                
                                conta += `DIVISAO, Load DIVIDENDO\n`
                                conta += `Add v1\n`
                                conta += `Store DIVIDENDO\n`
                                conta += `Load ${varDefinida}\n`
                                conta += `Subt i${counter}\n`
                                conta += `Store ${varDefinida}\n`
                                conta += `Skipcond 000\n`
                                conta += `Jump DIVISAO\n`
                                conta += `Load ${varDefinida}\n`
                                conta += `Subt ${varDefinida}\n`
                                conta += `Add DIVIDENDO\n`
                                conta += `Store ${varDefinida}\n`
                                break;
                        }
                    } else if(!firstOperation) {
                        let proximaOperacao;
                        
                        for(let j = i; j < linha.length; j++) {
                            if(linha[j] === ';' || verficaOperacao(linha[j])) {
                                proximaOperacao = j;
                                break;
                            }
                        }

                        let contaAtual = linha.slice(index, proximaOperacao )
                        index = proximaOperacao

                        switch(lastOperation) {
                            case '+':
                                contaAtual = contaAtual.split(lastOperation)
                                conta += `LOAD ${varDefinida}\n`
                                
                                for(let i in contaAtual) {
                                    if(typeof contaAtual[i] === 'number' && isFinite(contaAtual[i])) {
                                        conta += `Add ${contaAtual[i]}\n`;
                                    } else if(contaAtual[i] != '') {
                                        variables.push(`i${counter}, DEC ${contaAtual[i]}\n`)
                                        conta+= `Add i${counter}\n`
                                        counter++
                                    }
                                }
                                conta += `Store ${varDefinida}\n`
                                break;
                            case '-':
                                contaAtual = contaAtual.split(lastOperation)
                                conta += `LOAD ${varDefinida}\n`
                                for(let i in contaAtual) {
                                    if(typeof contaAtual[i] === 'number' && isFinite(contaAtual[i])) {
                                        conta += `Subt ${contaAtual[i]}\n`;
                                    } else if(contaAtual[i] != ''){
                                        variables.push(`i${counter}, DEC ${contaAtual[i]}\n`)
                                        conta+= `Subt i${counter}\n`
                                        counter++
                                    }
                                }
                                conta += `Store ${varDefinida}\n`
                                break;
                            case '*':
                                contaAtual = contaAtual.split(lastOperation)
                                
                                for(let i in contaAtual) 
                                    if(contaAtual[i] != '') 
                                        variables.push(`i${counter}, DEC ${contaAtual[i]}`)
                                
                                conta += `MULTIPLICACAOi${counter}, load SUM\n`
                                conta += `Add ${varDefinida}\n`
                                conta += `Store SUM\n`
                                conta += `Load i${counter}\n`
                                conta += `Subt v1\n`
                                conta += `Store i${counter}\n`
                                conta += `Skipcond 400\n`
                                conta += `Jump MULTIPLICACAOi${counter}\n`
                                counter++
                                break;
                            case '/':
                                contaAtual = contaAtual.split(lastOperation)
                                
                                for(let i in contaAtual) 
                                    if(contaAtual[i] != '') 
                                        variables.push(`i${counter}, DEC ${contaAtual[i]}`)
                                
                                conta += `DIVISAO, Load DIVIDENDO\n`
                                conta += `Add v1\n`
                                conta += `Store DIVIDENDO\n`
                                conta += `Load ${varDefinida}\n`
                                conta += `Subt i${counter}\n`
                                conta += `Store ${varDefinida}\n`
                                conta += `Skipcond 000\n`
                                conta += `Jump DIVISAO\n`
                                conta += `Load ${varDefinida}\n`
                                conta += `Subt ${varDefinida}\n`
                                conta += `Add DIVIDENDO\n`
                                conta += `Store ${varDefinida}\n`
                                break;
                        }
                    }

                    lastOperation = linha[i]
                }
            }

            if(conta != undefined)
                codigoMarie.push(conta + '\n')
        }


        function verficaOperacao(operacao) {
            for(let op in operacoes) {
                if(operacoes[op] === operacao) {
                    return true
                }
            }

            return false
        }


        // Adicionado função à classe String do Javascript para obter o valor em hexadecimal de uma string
        String.prototype.hexEncode = function(){
            var hex, i;
            var result = "";
            for (i=0; i<this.length; i++) {
                hex = this.charCodeAt(i).toString(16);
                if(hex != '22')
                    result += ("HEX 00"+ hex + '\n');
            }

            result += 'HEX 0000\n';

            return result
        }

    </script>
</html>