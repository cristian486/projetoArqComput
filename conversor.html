<!DOCTYPE html>
<html>
    <header>

    </header>

    <body>
        <header>
            <h1>Conversor C para MarieJS</h1>
        </header>

        <main>
            <textarea id="codigoFonte" cols="70" rows="30">
            </textarea>

            <textarea id="codigoDestino" cols="70" rows="30">
            </textarea>

            <button id="converter">Converter</button>
        </main>

        <footer>
            <p>Arquitetura de Computadores &copy; Ciência da Computação</p>
        </footer>
    </body>

    <script>
        let botaoConverter = document.querySelector('#converter');
        let obj = {};
        let codigoMarie = [];
        let variables = []
        let operacoes = ['+', '-', '*', '/']
        let counter = 1


        // Função para fazer com que ao selecionar o código em C o código no Marie seja ressaltado
        document.querySelector('#codigoFonte').addEventListener('click', e => {
            e.preventDefault()
            
            let start = document.querySelector('#codigoFonte').selectionStart
            let end = document.querySelector('#codigoFonte').selectionEnd
            let temp = document.querySelector('#codigoFonte').value.slice(start, end)

            let chaves = Object.keys(obj)
            for(let i = 0; i < chaves.length; i++) {
                if(chaves[i].includes(temp)) {

                }
            }
        })

/*
Tipos de dados em C:
char
int
float
void

#include <stdio.h>
#include <stdlib.h>

int main() {
int n, b, c = 0;
float a;

printf("Teste");


n = 1 + 5;
b = 8 - 9;
c = 1 * 10;
a = 10 / 2;

return 0;
}



Exemplo de código para multiplicação


input
store x

input
store y

loop, load sum
add x
store sum
load y
subt v1
store y
skipcond 400
jump loop

load sum
output

halt

x, dec 0
y, dec 0
v1, dec 1
sum, dec 0
        
*/
        
        

        // Ação do botão para converter o código em C para o Marie
        botaoConverter.addEventListener('click', () => {
            codigoMarie = [];
            variables = [];
            variables.push(`v1, DEC 1\n`)
            variables.push(`SUM, DEC 0\n`)
            document.querySelector('#codigoDestino').textContent = '';

            document.querySelector('#codigoFonte').value.trim().split('\n').forEach(linha => {

                if((linha.includes('int') && !linha.includes('print')) || linha.includes('char') || linha.includes('float') || linha.includes('void')) {
                    convertTypeToMarie(linha.trim());                
                } else if(linha.includes('if')) {

                } else if(linha.includes('printf')) {
                    convertPrintToMarie(linha.trim());
                } else if(linha.includes('/') || linha.includes('*') || linha.includes('-') || linha.includes('+')) {
                    convertOperationToMarie(linha);
                }

            })

            let string = '';
            codigoMarie.push(`\nHALT\n`)
            codigoMarie.forEach(linha => string += linha.trim() + '\n');
            variables.forEach(variavel => string += variavel.trim() + '\n')
            document.querySelector('#codigoDestino').textContent = string;
        })





        // Função para converter tipos de dados do C para o Marie. A ideia é converter tudo para hexadecimal para dar menos trabalho
        function convertTypeToMarie(linha) {
            if(linha.includes('(') && linha.includes(')') && linha.includes('{')) {
                if(!linha.includes('main')) {

                }
            } else if(linha.includes('(') && linha.includes(')') && !linha.includes('{')) {

            } else {

                if(linha.includes(',')) {
                    let texto = linha.split(',')
                    for(let i in texto) {
                        let textoOriginal = texto[i];
                        texto[i] = texto[i].replace('int', ' ')  || texto[i].replace('float', '') || texto[i].replace('char', '')  || texto[i].replace('void', '')
                        
                        if(texto[i].includes('=')) {
                            obj[textoOriginal] = `${texto[i].split('=')[0].trim().toUpperCase()}, DEC ${texto[i].split('=')[1].trim().replace(';', '')}`;
                            variables.push(`${texto[i].split('=')[0].trim().toUpperCase()}, DEC ${texto[i].split('=')[1].trim().replace(';', '')}`);
                        } else {
                            obj[textoOriginal] = `${texto[i].trim().toUpperCase()}, DEC 0`
                            variables.push(`${texto[i].trim().toUpperCase()}, DEC 0`);
                        }
                    }                                     
                } else {
                    obj[linha] = `${linha.slice(linha.trim().indexOf(' '), linha.indexOf('=') + 1 || linha.length).toUpperCase().replace(';', '')}, DEC 0`;
                    variables.push(`${linha.slice(linha.trim().indexOf(' '), linha.indexOf('=') + 1 || linha.length).toUpperCase().replace(';', '')}, DEC 0`);
                }
            }
        }


        // Função responsável por converter o printf (Função que escreve normalmente na saída padrão) para o print do Marie
        function convertPrintToMarie(linha) {
            if(linha.includes('%')) {
                
            } else {
                let texto = linha.substring(linha.indexOf("(") + 1, linha.indexOf(")"));
                let hexadecimalText = texto.trim().hexEncode()
                obj[linha] = `${texto.toUpperCase().replace(';', '')}, DEC 0`;
                codigoMarie.push(`${hexadecimalText.toUpperCase().replace(';', '')}`);
            }
        }


        // Converte uma operação básica (+, -, *, /) para o Marie
        function convertOperationToMarie(linha) {
            let operation;
            let valores = [];
            let variaveisUsadas = [];
            let conta = ``;
            
            for(let i in operacoes) {
                if(linha.includes(`${operacoes[i]}`)) {
                    operation = operacoes[i]

                    
                    for(let j in variables) {
                        let texto = linha.slice(linha.indexOf('=') + 1, linha.length).replace(';', '')
                        if(texto.toUpperCase().includes(`${variables[j]}`))
                            variaveisUsadas.push(variables[j])
                    }

                    break
                }
            }

            valores = linha.slice(linha.indexOf('=') + 1, linha.length).replace(';', '').split(operation);

            switch(operation) {
                case '+':
                    if(variaveisUsadas.length > 0) {
                        for(let i in variaveisUsadas) {
                            conta += `LOAD ${linha.slice(0, linha.indexOf('=')).toUpperCase()}\n`
                            conta += `ADD ${variaveisUsadas[i]}\n`
                        }
                    }

                    for(let i in valores) {
                        variables.push(`i${counter}, DEC ${valores[i]}\n`)
                        conta += `LOAD ${linha.slice(0, linha.indexOf('=')).toUpperCase()}\n`
                        conta += `ADD i${counter}\n`
                        conta += `STORE ${linha.slice(0, linha.indexOf('=')).toUpperCase()}\n`
                        counter++
                    }

                    obj[linha] = conta
                    break;
                case '-':
                    if(variaveisUsadas.length > 0) {
                        for(let i in variaveisUsadas) {
                            conta += `LOAD ${linha.slice(0, linha.indexOf('=')).toUpperCase()}\n`
                            conta += `ADD ${variaveisUsadas[i]}\n`
                        }
                    }

                    for(let i in valores) {
                        variables.push(`i${counter}, DEC ${valores[i]}\n`)
                        conta += `LOAD ${linha.slice(0, linha.indexOf('=')).toUpperCase()}\n`
                        conta += `SUBT i${counter}\n`
                        conta += `STORE ${linha.slice(0, linha.indexOf('=')).toUpperCase()}\n`
                        counter++
                    }

                    obj[linha] = conta
                    break;
                case '*':
                    if(variaveisUsadas.length > 0) {
                        for(let i in variaveisUsadas) {
                            conta += `LOAD ${linha.slice(0, linha.indexOf('=')).toUpperCase()}\n`
                            conta += `ADD ${variaveisUsadas[i]}\n`
                        }
                    }
                    break;
                case '/':
                    break;
            }

            if(conta != undefined)
                codigoMarie.push(conta + '\n')
        }


        

        // Adicionado função à classe String do Javascript para obter o valor em hexadecimal de uma string
        String.prototype.hexEncode = function(){
            var hex, i;
            var result = "";
            for (i=0; i<this.length; i++) {
                hex = this.charCodeAt(i).toString(16);
                if(hex != '22')
                    result += ("HEX 00"+ hex + '\n');
            }

            result += 'HEX 0000\n';

            return result
        }

    </script>
</html>